<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Short-sighted Kitten</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <body>
        <h1>Short-sighted Kitten</h1>
        <div class="row">
            <img src="cat.png"/>
            <img src="cat-with-eyeglasses.png"/>
            <img src="cat-with-speech-bubble.png"/>
        </div>
        <form method="post" action="" enctype="multipart/form-data" id="myform">
            <div >
                <input type="file" id="file" name="file" />
            </div>
        </form>
        <div class='preview'>
            <img src="" id="img" width="100" height="100">
        </div>
        <div class="wrapper">
            <canvas id="canvasCat" style="z-index: 1"></canvas>
            <canvas id="canvasEyeglasses" style="z-index: 2"></canvas>
            <canvas id="canvasBubble" style="z-index: 3"></canvas>
            <canvas id="canvasText" style="z-index: 4"></canvas>
        </div>

        <script src="jquery-3.3.1.js"></script>
        <script>
            document.getElementById("file").onchange = function () {
                previewOriginalImage(this);

                /**
                // upload image in form of FormData
                var fd = new FormData();
                var files = $('#file')[0].files[0];
                fd.append('file',files);
                $.ajax({
                    url: '',
                    type: 'post',
                    data: fd,
                    contentType: false,
                    processData: false,
                    success: function(response){
                        drawNewImage('temp.jpg');
                        setTimeout(drawAugmentedEffect, 100, 115, 122, 179, 121, 133, 169);
                    },
                });
                **/

                // Try two images

                drawNewImage('temp.jpg');
                setTimeout(drawAugmentedEffect, 100, 115, 122, 179, 121, 133, 169);

                //drawNewImage('temp2.jpg');
                //setTimeout(drawAugmentedEffect, 100, 263, 433, 379, 286, 418, 466);
            };

            function previewOriginalImage(input) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    // get loaded data and render thumbnail.
                    document.getElementById("img").src = e.target.result;
                };
                // read the image file as a data URL.
                reader.readAsDataURL(input.files[0]);
            }
            
            var canvasCat = document.getElementById("canvasCat");
            var canvasEyeglasses = document.getElementById("canvasEyeglasses");
            var canvasBubble = document.getElementById("canvasBubble");
            var canvasText = document.getElementById("canvasText");

            function drawNewImage(imgSrc) {
                // Draw cat image
                var cat = new Image();
                cat.onload = function() {
                    canvasCat.width = cat.width;
                    canvasCat.height = cat.height;
                    canvasEyeglasses.width = cat.width;
                    canvasEyeglasses.height = cat.height;
                    canvasBubble.width = cat.width;
                    canvasBubble.height = cat.height;
                    canvasText.width = cat.width;
                    canvasText.height = cat.height;


                    var ctx = canvasCat.getContext('2d');
                    ctx.drawImage(cat, 0, 0, cat.width, cat.height);
                };
                cat.src = imgSrc;
            }

            function drawAugmentedEffect(leftEyeX, leftEyeY, rightEyeX, rightEyeY, mouthX, mouthY) {
                eyeCenterX = (leftEyeX + rightEyeX) / 2;
                eyeCenterY = (leftEyeY + rightEyeY) / 2;

                rotation = Math.atan2(rightEyeY - leftEyeY, rightEyeX - leftEyeX);

                // Draw eyeglasses
                var eyeglasses = new Image();
                eyeglasses.onload = function() {
                    scale = Math.hypot((leftEyeX - rightEyeX), (leftEyeY - rightEyeY)) / (eyeglasses.width / 2);

                    width = eyeglasses.width * scale;
                    height = eyeglasses.height * scale;

                    var ctx = canvasEyeglasses.getContext('2d');
                    ctx.translate(eyeCenterX, eyeCenterY);
                    ctx.rotate(rotation);
                    ctx.drawImage(eyeglasses, - width / 2, - height / 2, width, height);
                };
                eyeglasses.src = 'eyeglasses.png';

                // Draw speech bubble
                var bubble = new Image();
                bubble.onload = function() {
                    scale = Math.hypot((eyeCenterX - mouthX), (eyeCenterY - mouthY)) / (bubble.height / 2);

                    width = bubble.width * scale;
                    height = bubble.height * scale;

                    ctxScaleX = leftEyeX < rightEyeX ? -1 : 1;

                    var ctx = canvasBubble.getContext('2d');
                    ctx.translate(mouthX, mouthY);
                    ctx.scale(ctxScaleX, 1);
                    //ctx.rotate(rotation);
                    ctx.drawImage(bubble, -width, 0, width, height);
                
                    // Draw text in bubble
                    var ctx = canvasText.getContext('2d');
                    ctx.translate(mouthX, mouthY);
                    ctx.font = "30px Comic Sans MS";
                    ctx.textAlign = "center";
                    ctx.fillText("Meow", width / 2,  height / 2);
                };
                bubble.src = 'bubble.png';
            }
        </script>
    </body>
</html>