<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Short-sighted Kitten</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css" />
    <link rel="stylesheet" type="text/css" href="/static/dropzone.min.css" />
  </head>

  <body>
    <h1>Short-sighted Kitten</h1>

    <div class="row">
      <img src="/static/cat.png" />
      <img src="/static/cat-with-eyeglasses.png" />
      <img src="/static/cat-with-speech-bubble.png" />
    </div>

    <form id="form" class="dropzone"></form>

    <canvas id="cat"></canvas>
    <button id="download">Download</button>

    <div style="display: none;">
      <img id="eyeglasses" src="/static/eyeglasses.png" />
      <img id="bubble" src="/static/bubble.png" />
    </div>

    <script src="/static/dropzone.min.js"></script>
    <script src="/static/fabric.min.js"></script>

    <script>
      Dropzone.autoDiscover = false;
      const dropzone = new Dropzone("#form", {
        url: "/detect",
        paramName: "file",
        acceptedFiles: "image/jpeg,image/png,image/gif,image/bmp",
      });

      dropzone.on("success", (e, data) => {
        if (data.success) {
          // TODO: handle empty landmarks
          drawCat(e.dataURL, e.name, data.landmarks);
        } else {
          alert(data.error);
        }
      });

      function drawCat(url, filename, landmarks) {
        const canvas = new fabric.Canvas("cat");

        fabric.Image.fromURL(url, (img) => {
          const { width, height } = img.getOriginalSize();
          canvas.setWidth(width);
          canvas.setHeight(height);
          canvas.setBackgroundImage(img);

          for (landmark of landmarks) {
            drawEyeglasses(canvas, landmark);
            drawBubble(canvas, landmark);
          }
        });

        const button = document.getElementById("download");
        button.addEventListener("click", () => {
          const url = canvas.toDataURL({
            format: "jpeg",
          });

          const link = document.createElement("a");
          link.download = filename;
          link.href = url;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }

      function drawEyeglasses(canvas, landmarks) {
        const [
          leftEyeX,
          leftEyeY,
          rightEyeX,
          rightEyeY,
          mouthX,
          mouthY,
        ] = landmarks;
        const imgElem = document.getElementById("eyeglasses");

        const eyeCenterX = (leftEyeX + rightEyeX) / 2;
        const eyeCenterY = (leftEyeY + rightEyeY) / 2;

        const angle =
          (Math.atan2(rightEyeY - leftEyeY, rightEyeX - leftEyeX) / Math.PI) *
          180;

        const scale =
          Math.hypot(leftEyeX - rightEyeX, leftEyeY - rightEyeY) /
          (imgElem.width / 2);

        const width = imgElem.width * scale;
        const height = imgElem.height * scale;

        const img = new fabric.Image(imgElem, {
          left: eyeCenterX,
          top: eyeCenterY,
          originX: "center",
          originY: "center",
        })
          .scaleToWidth(width)
          .scaleToHeight(height)
          .rotate(angle);
        canvas.add(img);
      }

      function drawBubble(canvas, landmarks) {
        const [
          leftEyeX,
          leftEyeY,
          rightEyeX,
          rightEyeY,
          mouthX,
          mouthY,
        ] = landmarks;
        const imgElem = document.getElementById("bubble");

        const eyeCenterX = (leftEyeX + rightEyeX) / 2;
        const eyeCenterY = (leftEyeY + rightEyeY) / 2;

        const scale =
          Math.hypot(eyeCenterX - mouthX, eyeCenterY - mouthY) /
          (imgElem.height / 2);

        const width = imgElem.width * scale;
        const height = imgElem.height * scale;

        const img = new fabric.Image(imgElem, {
          left: mouthX,
          top: mouthY,
          flipX: leftEyeX < rightEyeX,
        })
          .scaleToWidth(width)
          .scaleToHeight(height);
        canvas.add(img);

        const text = new fabric.Text("Meow", {
          fontFamily: "Comic Sans MS",
          fontSize: 30,
          left: mouthX + width / 2,
          top: mouthY + height / 2,
          originX: "center",
          originY: "center",
        });
        canvas.add(text);
      }
    </script>
  </body>
</html>
